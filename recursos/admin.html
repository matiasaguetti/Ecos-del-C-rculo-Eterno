<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Recursos (Libros)</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body{ font-family:Inter,system-ui,Arial; padding:18px; background:linear-gradient(180deg,#070708,#0d0d0e); color:#e6eef1 }
    .card{ background:rgba(255,255,255,0.02); padding:16px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); max-width:980px; margin:0 auto;}
    label{ display:block; margin-top:10px; font-size:13px }
    input[type=text], textarea, select { width:100%; padding:9px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; box-sizing:border-box }
    .row{ display:flex; gap:8px; align-items:center; }
    .btn{ background:var(--accent); color:#fff; border:none; padding:9px 14px; border-radius:8px; cursor:pointer; margin-top:12px; font-weight:700 }
    .btn.secondary{ background:#2b7a4f }
    .thumbs img{ max-height:90px; margin-right:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04) }
    .modes { display:flex; gap:8px; margin-top:8px; }
    .rich-area { min-height:140px; border:1px dashed rgba(255,255,255,0.06); padding:10px; border-radius:6px; background:rgba(0,0,0,0.02); color:inherit; overflow:auto }
    .note { color:#aab2b6; font-size:13px; margin-top:8px }
    pre#log{ height:160px; overflow:auto; background:#070708; border-radius:6px; padding:8px; color:#d8e0e3 }
  </style>
</head>
<body>
  <main class="card" role="main">
    <h2>Admin — Libros y Pergaminos (Cap.05)</h2>
    <p class="note">Sube entradas (título, subtítulo, fecha, texto) y las imágenes asociadas. El campo Texto acepta HTML (pegar desde Google Docs), Markdown o texto plano. Las imágenes se guardarán en <code>assets/recursos/</code>.</p>

    <label>Owner (usuario/org)</label>
    <input id="owner" type="text" placeholder="tu-usuario" />

    <label>Repo</label>
    <input id="repo" type="text" placeholder="nombre-del-repo" />

    <label>Branch (por defecto: main)</label>
    <input id="branch" type="text" placeholder="main" />

    <label>Personal Access Token (PAT)</label>
    <input id="token" type="text" placeholder="ghp_xxx..." />

    <hr/>

    <h3>Nuevo pergamino / libro</h3>

    <label>Título</label>
    <input id="title" type="text" />

    <label>Subtítulo (se mostrará en cursiva)</label>
    <input id="subtitle" type="text" />

    <label>Fecha</label>
    <input id="date" type="text" placeholder="2025-08-30" />

    <label>Modo de pegado</label>
    <div class="modes">
      <label><input name="mode" type="radio" value="text" checked> Texto plano</label>
      <label><input name="mode" type="radio" value="html"> HTML</label>
      <label><input name="mode" type="radio" value="md"> Markdown</label>
    </div>

    <label>Texto</label>
    <textarea id="bodyText" rows="6" placeholder="Texto o Markdown"></textarea>

    <div id="bodyHtmlContainer" style="display:none; margin-top:8px;">
      <div id="bodyHtml" class="rich-area" contenteditable="true"></div>
      <div class="note">Pega desde Google Docs aquí para conservar formato.</div>
    </div>

    <label>Imágenes (PNG/JPG → JPG optimizado en assets/recursos/)</label>
    <input id="images" type="file" accept="image/*" multiple />
    <div class="thumbs" id="thumbs"></div>
    <div style="margin-top:8px">
      <button id="clearImgs" class="btn secondary" type="button">Limpiar imágenes</button>
    </div>

    <div style="margin-top:12px">
      <button id="addBtn" class="btn" type="button">Añadir pergamino</button>
      <button id="uploadBtn" class="btn secondary" type="button">Subir JSON + imágenes</button>
    </div>

    <hr/>
    <h3>Preview / Estado</h3>
    <pre id="log"></pre>
  </main>

  <script>
    const imgsInput=document.getElementById('images');
    const thumbs=document.getElementById('thumbs');
    const addBtn=document.getElementById('addBtn');
    const uploadBtn=document.getElementById('uploadBtn');
    const clearImgsBtn=document.getElementById('clearImgs');
    const logEl=document.getElementById('log');
    let localItems=[]; const imageMap={}; let stagedFiles=[];
    function log(msg){logEl.textContent=(new Date()).toISOString()+" — "+msg+"\n"+logEl.textContent;}
    function sanitizeFilename(name){const ext='.jpg'; const base=name.replace(/(\.[^.]+)$/,'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9\-_ ]/g,'').trim().replace(/\s+/g,'-').toLowerCase();return(base||'img')+ext;}
    function fileToJpegBase64(file,q=0.78,maxW=2000){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>{const img=new Image();img.onload=()=>{let w=img.width,h=img.height;if(maxW&&w>maxW){h=Math.round(h*(maxW/w));w=maxW;}const c=document.createElement('canvas');c.width=w;c.height=h;const ctx=c.getContext('2d');ctx.fillStyle='#000';ctx.fillRect(0,0,w,h);ctx.drawImage(img,0,0,w,h);c.toBlob(b=>{const rr=new FileReader();rr.onload=()=>{res(rr.result.split(',')[1]);};rr.readAsDataURL(b);},'image/jpeg',q);};img.src=r.result;};r.readAsDataURL(file);});}
    async function putFile(owner,repo,path,content,message,branch,token){const api=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;let sha=null;const headers={Authorization:'token '+token,Accept:'application/vnd.github+json'};try{const g=await fetch(api+'?ref='+branch,{headers});if(g.ok){const info=await g.json();sha=info.sha||null;}}catch{}const body={message,content,branch};if(sha)body.sha=sha;const resp=await fetch(api,{method:'PUT',headers,body:JSON.stringify(body)});if(!resp.ok)throw new Error('PUT failed '+resp.status);return await resp.json();}
    imgsInput.addEventListener('change',()=>{thumbs.innerHTML='';stagedFiles=Array.from(imgsInput.files||[]);stagedFiles.forEach(f=>{const img=document.createElement('img');img.src=URL.createObjectURL(f);thumbs.appendChild(img);});});
    clearImgsBtn.addEventListener('click',()=>{imgsInput.value='';stagedFiles=[];thumbs.innerHTML='';});
    addBtn.addEventListener('click',()=>{const t=document.getElementById('title').value.trim();const st=document.getElementById('subtitle').value.trim();const d=document.getElementById('date').value.trim();const m=document.querySelector('input[name="mode"]:checked').value;let b='';if(m==='html'){b=document.getElementById('bodyHtml').innerHTML.trim();}else{b=document.getElementById('bodyText').value.trim();}if(!t||!b){alert('Completa título y texto');return;}const id=Date.now();const imgPaths=[];stagedFiles.forEach(f=>{const safe=sanitizeFilename(f.name).replace('.jpg','')+'-'+id+'.jpg';const full='assets/recursos/'+safe;imageMap[full]=f;imgPaths.push(full);});localItems.push({id,title:t,subtitle:st,date:d,body:b,images:imgPaths});document.getElementById('title').value='';document.getElementById('subtitle').value='';document.getElementById('date').value='';document.getElementById('bodyText').value='';document.getElementById('bodyHtml').innerHTML='';});
    uploadBtn.addEventListener('click', async()=>{
  const o=document.getElementById('owner').value.trim();
  const r=document.getElementById('repo').value.trim();
  const b=document.getElementById('branch').value.trim()||'main';
  const t=document.getElementById('token').value.trim();
  if(!o||!r||!t){alert('Faltan credenciales');return;}

  // 1) subir imágenes (como ya hacías)
  for(const path of Object.keys(imageMap)){
    const file=imageMap[path];
    const b64=await fileToJpegBase64(file);
    await putFile(o,r,path,b64,'Upload '+path,b,t);
    log('Subida imagen '+path);
  }

  // 2) determinar ruta JSON en repo
  const jsonPath = 'recursos/libros-05.json';
  // 3) intentar leer JSON existente desde la API de GitHub para fusionar
  let existing = [];
  try {
    const apiUrl = `https://api.github.com/repos/${o}/${r}/contents/${encodeURIComponent(jsonPath)}?ref=${b}`;
    const resp = await fetch(apiUrl, { headers: { Authorization: 'token '+t, Accept:'application/vnd.github+json' } });
    if (resp.ok) {
      const info = await resp.json();
      if (info && info.content) {
        try {
          // content viene en base64
          const decoded = decodeURIComponent(escape(atob(info.content)));
          const parsed = JSON.parse(decoded);
          if (Array.isArray(parsed)) existing = parsed;
          log('Archivo existente leído ('+parsed.length+' items)');
        } catch(e) {
          console.warn('No se pudo parsear JSON existente:', e);
        }
      }
    } else {
      // 404 -> no existe, seguiremos con empty existing
      log('No existía ' + jsonPath + ' en el repo (se creará).');
    }
  } catch(e){
    console.warn('Lectura previa falló:', e);
  }

  // 4) fusionar (append) existing + localItems
  const combined = existing.concat(localItems || []);
  const jsonStr = JSON.stringify(combined, null, 2);
  const b64json = btoa(unescape(encodeURIComponent(jsonStr)));
  await putFile(o,r,jsonPath,b64json,'Update JSON libros-05 (append)',b,t);
  alert('Todo subido OK (imágenes + JSON combinado)');
  log('JSON subido: ' + jsonPath + ' (items totales: ' + combined.length + ')');
});

    document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change',()=>{const v=document.querySelector('input[name="mode"]:checked').value;document.getElementById('bodyHtmlContainer').style.display=(v==='html')?'block':'none';document.getElementById('bodyText').style.display=(v==='html')?'none':'block';}));
  </script>
</body>
</html>
