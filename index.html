<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ecos del Círculo eterno — Diario de campaña</title>
  <meta name="description" content="Ecos del Círculo eterno: registro de sesiones, galería de mapas y recursos de la partida (D&D 5e)."/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="banner">
    <div>
      <div class="camp-name">Ecos del Círculo eterno</div>
      <div class="camp-sub">Diario de campaña — crónicas, mapas y recursos</div>
    </div>
    <nav aria-label="navegación principal">
      <a class="navlink" href="/mapas.html">Mapas</a>
      <a class="navlink" href="/recursos.html">Recursos</a>
      <a class="navlink" href="/notas.html">Notas</a>
    </nav>
  </header>

  <main class="wrap">
    <!-- Slideshow -->
    <section class="slideshow" id="slideshow">
      <div id="slides" class="slides" aria-live="polite"></div>

      <!-- Controles dentro del área de imagen para no tapar el texto -->
      <div class="controls">
        <button id="prev" class="ctrl-btn" aria-label="anterior">‹</button>
        <button id="next" class="ctrl-btn" aria-label="siguiente">›</button>
      </div>

      <div class="dots" id="dots" role="tablist"></div>
    </section>

    <!-- Accesos -->
    <section class="sections">
      <article class="section-card">
        <h4>Mapas</h4>
        <p>Galería y planos de la campaña. (Página: <code>/mapas.html</code>).</p>
      </article>
      <article class="section-card">
        <h4>Recursos</h4>
        <p>Objetos, handouts y material descargable. (Página: <code>/recursos.html</code>).</p>
      </article>
      <article class="section-card">
        <h4>Notas</h4>
        <p>Zona de anotaciones y registros de los jugadores. (Página: <code>/notas.html</code>).</p>
      </article>
    </section>
  </main>

  <footer>Creado para la campaña «Ecos del Círculo eterno»</footer>

  <script>
    // --- Slideshow (lee slides.json) ---
    let posts = [];
    let current = 0, timer = null;
    const interval = 6000;

    async function loadSlides(){
      try {
        const res = await fetch("slides.json", { cache: "no-store" });
        posts = await res.json();
      } catch(e) {
        console.warn("No se pudo cargar slides.json", e);
        posts = [];
      }
      buildSlides();
      show(0);
      startTimer();
    }

    function buildSlides(){
      const container = document.getElementById('slides');
      const dots = document.getElementById('dots');
      container.innerHTML = "";
      dots.innerHTML = "";

      if(!Array.isArray(posts) || posts.length===0){
        container.innerHTML = `
          <section class="slide">
            <div class="slide-media">
              <img src="assets/placeholder.jpg" alt="placeholder">
            </div>
            <div class="slide-meta">
              <h3>Bienvenido</h3>
              <div class="date">—</div>
              <p>No hay entradas todavía. Usa <code>admin.html</code> para crear <code>slides.json</code>.</p>
            </div>
          </section>`;
        const dot = document.createElement("div"); dot.className = "dot active"; dots.appendChild(dot);
        return;
      }

      posts
        .slice()
        .sort((a,b)=> new Date(b.date) - new Date(a.date))
        .forEach((p,idx)=>{
          const slide = document.createElement("section");
          slide.className = "slide";

          const imgSrc = (p.images && p.images[0]) ? p.images[0] : "assets/placeholder.jpg";
          slide.innerHTML = `
            <div class="slide-media">
              <img src="${imgSrc}" alt="${escapeHtml(p.title || 'captura')}">
            </div>
            <div class="slide-meta">
              <h3>${escapeHtml(p.title || 'Sin título')}</h3>
              <div class="date">${escapeHtml(p.date || '')}</div>
              <p>${escapeHtml(p.body || '')}</p>
            </div>`;

          container.appendChild(slide);

          const dot = document.createElement("div");
          dot.className = "dot";
          dot.addEventListener("click", ()=> goTo(idx));
          dots.appendChild(dot);
        });

      updateDots(0);
    }

    function show(index){
      const slides = document.getElementById("slides");
      const n = slides.children.length;
      if(n===0) return;
      current = ((index % n)+n)%n;
      slides.style.transform = `translateX(${-current * 100}%)`;
      updateDots(current);
    }
    function next(){ show(current+1) }
    function prev(){ show(current-1) }
    function goTo(i){ show(i); resetTimer(); }
    function updateDots(active){
      document.querySelectorAll("#dots .dot").forEach((d,i)=>
        d.classList.toggle("active", i===active));
    }
    function startTimer(){ if(timer) clearInterval(timer); timer=setInterval(()=> next(), interval); }
    function resetTimer(){ startTimer(); }

    document.getElementById("next").addEventListener("click", ()=>{ next(); resetTimer(); });
    document.getElementById("prev").addEventListener("click", ()=>{ prev(); resetTimer(); });

    function escapeHtml(str){
      return String(str)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
        .replace(/'/g,"&#39;");
    }

    // Pausa en hover
    const slideshow = document.getElementById('slideshow');
    slideshow.addEventListener('mouseenter', ()=>{ if(timer) clearInterval(timer); });
    slideshow.addEventListener('mouseleave', ()=>{ startTimer(); });

    loadSlides();
  </script>
</body>
</html>
